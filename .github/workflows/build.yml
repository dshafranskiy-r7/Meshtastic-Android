name: Build APKs

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        module: [app, wear]
        flavor: [google, fdroid]
        exclude:
          # Wear OS only needs one flavor for now
          - module: wear
            flavor: fdroid

    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          build-scan-publish: true
          build-scan-terms-of-use-url: 'https://gradle.com/terms-of-service'
          build-scan-terms-of-use-agree: 'yes'

      - name: Create secrets.properties
        run: |
          touch secrets.properties
          echo "MAPS_API_KEY=fake_key_for_build" >> secrets.properties
          echo "datadogApplicationId=fake_id" >> secrets.properties
          echo "datadogClientToken=fake_token" >> secrets.properties

      - name: Calculate Version Code
        id: version
        uses: ./.github/actions/calculate-version-code

      - name: Build APK
        env:
          VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
        run: |
          if [ "${{ matrix.module }}" = "app" ]; then
            FLAVOR_CAP=$(echo ${{ matrix.flavor }} | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')
            ./gradlew :app:assemble${FLAVOR_CAP}Debug -Pci=true --scan
          else
            ./gradlew :wear:assembleDebug -Pci=true --scan
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.module }}-${{ matrix.flavor }}-debug
          path: |
            app/build/outputs/apk/${{ matrix.flavor }}/debug/*.apk
            wear/build/outputs/apk/debug/*.apk
          retention-days: 14

      - name: Report App Size
        if: always()
        run: |
          echo "### ðŸ“¦ APK Size Report - ${{ matrix.module }} (${{ matrix.flavor }})" >> $GITHUB_STEP_SUMMARY
          echo "| APK | Size |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          find ${{ matrix.module }}/build/outputs/apk -name "*.apk" -exec du -h {} + | awk '{print "| " $2 " | " $1 " |"}' >> $GITHUB_STEP_SUMMARY || true